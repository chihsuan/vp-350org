!function(t){function e(t,e){var a=d3.max(t,function(t){return t.value}),c=d3.scale.linear().domain([0,a]).range([5,15]);e.forEach(function(t){-1===r.indexOf(t.properties.name)&&(d[t.properties.name]=l.centroid(t))}),t=t.filter(function(t){return n.indexOf(t.source)>-1}),console.log(t);var p=s.selectAll(".defs").data(t).enter().append("svg:defs"),f=function(t){return"marker"+t.source.replace(" ","")+t.target.replace(" ","")};p.append("marker").attr("id",f).attr("viewBox","0 -5 10 10").attr("refX",5).attr("refY",0).attr("orient","auto").attr("markerUnits","userSpaceOnUse").attr("markerWidth",function(t){return 3.5*c(t.value)}).attr("markerHeight",function(t){return 2.5*c(t.value)}).append("path").attr("d","M0,-5L10,0L0,5").attr("fill","rgba(196, 0, 0, 0.75)");var m=function(t){return"grd"+t.source.replace(" ","")+t.target.replace(" ","")},g=function(t){return"url(#"+m(t)+")"},h=d3.scale.log().domain([1,a]).range(["rgb(193,39,45)","#b52626"]),y=function(t){return h(t.value)},x=p.selectAll("linearGradient").data(t).enter().append("svg:linearGradient").attr("id",m).attr("gradientUnits","userSpaceOnUse").attr("x1",function(t){return d[t.source][0]}).attr("y1",function(t){return d[t.source][1]}).attr("x2",function(t){return d[t.target][0]}).attr("y2",function(t){return d[t.target][0]});x.append("svg:stop").attr("offset","0%").attr("stop-color","rgb(193,39,45)").attr("stop-opacity",.2),x.append("svg:stop").attr("offset","80%").attr("stop-color",y).attr("stop-opacity",1),x.append("svg:stop").attr("offset","100%").attr("stop-color",y).attr("stop-opacity",1);var v=s.append("g").attr("id","arcs"),k=v.selectAll("g").data(t).enter().append("g");k.append("path").attr("stroke",g).attr("stroke-linecap","round").attr("stroke-width",function(t){return c(t.value)}).attr("class",function(t){return t.target+"-link"}).attr("d",function(t){return l({type:"LineString",coordinates:[u.invert(d[t.source]),u.invert(d[t.target])]})}).attr("marker-end",function(t){return"url(#"+f(t)+")"}).style("display","none");k.append("circle").attr("cx",function(t){return d[t.source][0]}).attr("cy",function(t){return d[t.source][1]-5}).attr("class",function(t){return t.target+"-link"}).attr("r",function(t){return t.value>1e3?30:25}).style("display","none").attr("text-anchor","middle"),k.append("text").attr("x",function(t){return d[t.source][0]}).attr("y",function(t){return d[t.source][1]}).attr("class",function(t){return t.target+"-link"}).text(function(t){return t.value+""}).style("display","none").attr("text-anchor","middle"),i||(s.append("text").attr("x",50).attr("y",o/5*2.2).attr("class","w-title").text("JOIN DIVESTMENT MOVEMENT!"),s.append("text").attr("x",50).attr("y",o/5*2.2+25).attr("class","w-sub-title").text("STOP EAST ASIA FOSSIL FUEL FINANCIAL FLOW!"))}var r=["Vietnam","Japan","Taiwan","South Korea","Indonesia","Philippines"],n=["China","Taiwan","Japan","Vietnam","North Korea","South Korea","Philippines","Thailand","Malaysia","Indonesia","Cambodia","Laos","Myanmar","Singapore","Brunei","East Timor","Mongolia"],a=$(t).width(),o=$(t).height(),i=a<769,s=d3.select("#east-asia-map").append("svg").attr("width",a).attr("height",o),c=i?200:450,p=[107,25],u=d3.geo.mercator().scale(c).center(p).translate([a/2+10,o/2+50]),l=d3.geo.path().projection(u),d={Vietnam:u([105.51,21.02]),Japan:u([139.4254,35.422]),Taiwan:u([121.564558]),"South Korea":u([126.5841,37.34]),Indonesia:u([106.48,6.12]),Philippines:u([120.58,14.35])};if(i){var f=r.slice();f.unshift("Select A Country"),d3.select("body").append("form").attr("class","m-country-select form-group").append("select").attr("class","form-control").on("change",function(e){t.location.href="./"+this.value.toLowerCase()}).selectAll("option").data(f).enter().append("option").attr("value",function(t){return t}).text(function(t){return t})}d3.json("./data/countries.geo.topo.json",function(c,p){if(c)return console.error(c);var u=topojson.feature(p,p.objects["countries.geo"]).features.filter(function(t){return n.indexOf(t.properties.name)>-1});s.append("g").attr("class","countries").selectAll("path").data(u).enter().append("path").attr("d",l).style("cursor",function(t){if(r.indexOf(t.properties.name)>-1)return"pointer"}).style("fill",function(t){if(r.indexOf(t.properties.name)>-1)return"rgba(255, 255, 255, 0.75)"}).on("mouseover",function(t){r.indexOf(t.properties.name)>-1&&(d3.select(this).style("opacity",.8),d3.selectAll("."+t.properties.name+"-link").style("display","block")),d3.select(".map-title").text(t.properties.name)}).on("mouseout",function(t){d3.select(this).style("opacity",1),d3.select(".map-title").text("East Asia"),d3.selectAll("."+t.properties.name+"-link").style("display","none")}).on("click",function(e){r.indexOf(e.properties.name)>-1&&(t.location.href="./"+e.properties.name.toLowerCase())}),s.append("path").attr("class","country-borders").attr("d",l(topojson.mesh(p,p.objects["countries.geo"],function(t,e){return n.indexOf(t.properties.name)>-1&&t!==e}))),s.append("text").text("East Asia").attr("class","map-title").attr("text-anchor","middle").attr("y",function(){return i?"50":o/2+50}).attr("x",function(){return i?a/2:a/6*5}),d3.json("./data/flow.json",function(t){e(t,u)})})}(window);