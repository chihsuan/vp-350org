!function(t){function e(e,c,l,u,p,d){document.getElementById("bank-vis-title").innerText="Financiers for "+e+" Coal Plant",document.getElementById("project-vis-title").innerText="Coal Plants in "+e;var m=o<600;m&&(l=u);var g=d3.geo.mercator().scale(l).center(c).translate([o/2+10,i/2+50]),f=d3.geo.path().projection(g);d3.json("./data/countries.geo.topo.json",function(c,l){d3.csv(p,function(u){if(c)return console.error(c);var p=topojson.feature(l,l.objects["countries.geo"]).features;p=p.filter(function(t){return t.properties.name===e}),s.append("g").attr("class","countries").selectAll("path").data(p).enter().append("path").attr("d",f).style("display",function(t){return r.indexOf(t.properties.name)>-1?"block":"none"}),s.append("path").attr("class","country-borders").attr("d",f(topojson.mesh(l,l.objects["countries.geo"],function(t,n){return t.properties.name===e&&t!==n}))),u=u.filter(function(t){return"Vietnam"===e?t.country===e&&t.latitude&&t.longitude:t.latitude&&t.longitude}).map(function(t){return t.longitude=parseFloat(t.longitude),t.latitude=parseFloat(t.latitude),t.capacity_mw=parseFloat(t.capacity_mw),t}),s.append("text").text(e).attr("class","map-title").attr("y",function(){return m?"120px":i/2}).attr("x",function(){return m?o/2:o-100}).attr("text-anchor",function(){return m?"middle":"end"}),s.append("text").text(function(){return u.length+" Coal Plants"}).attr("class","map-subtitle").attr("y",function(){return m?150:i/2+35}).attr("x",function(){return m?o/2:o-100}).attr("text-anchor",function(){return m?"middle":"end"}).attr("cursor","pointer").on("click",function(){t.location.href="#project-vis-title"});var d=m?10:25,h=d3.scale.linear().domain([0,d3.max(u,function(t){return t.capacity_mw})]).range([5,d]);s.selectAll("circle").data(u).enter().append("circle").attr("cx",function(t){return g([t.longitude,t.latitude])[0]}).attr("cy",function(t){return g([t.longitude,t.latitude])[1]}).attr("r",function(t){return h(t.capacity_mw)}).on("mousemove",function(t){"Vietnam"===e?n(t,"<p><strong>Plant: </strong>"+t.plant+"</p><p><strong>Capacity (MW): </strong>"+t.capacity_mw+"</p><p><strong>Coal Type: </strong>"+t.coal_type+"</p><p><strong>Unit: </strong>"+t.unit+"</p><p><strong>Year: </strong>"+t.year+"</p><p><strong>Status: </strong>"+t.status+"</p>"):n(t,"<p><strong>Project Name: </strong>"+t["Project Name"]+"</p><p><strong>Capacity (MW): </strong>"+t.capacity_mw+"</p><p><strong>Coal Type: </strong>"+t.Types+"</p><p><strong>Unit: </strong>"+t.Unit+"</p><p><strong>Year: </strong>"+t["Established date (yr)"]+"</p><p><strong>Status: </strong>"+t.Status+"</p>")}).on("mouseout",a);var y=i-40;s.append("circle").attr("cx",20).attr("cy",y).attr("r","8px").attr("fill","red"),s.append("text").attr("x",35).attr("y",y+5).attr("r","8px").attr("fill","red").attr("class","legend").text("Coal Plants Capacity"),s.append("text").attr("x",35).attr("y",function(){return m?y+25:y+30}).attr("r","8px").attr("fill","red").attr("class","legend").text("Data Last Updatedï¼š2017"),s.append("circle").attr("cx",20).attr("cy",function(){return m?y+20:y+25}).attr("r","5px").style("fill","#fff").style("stroke","none")})}),d3.csv(d,function(t){function e(t,e){var n=16,a=t.name,r=t.dx,o=t.dy;for(d3.select(this).style("font-size",n+"px");(this.getBBox().width>=r||this.getBBox().height>=o)&&n>10;)n--,d3.select(this).style("font-size",n+"px"),this.firstChild.data=a;this.parentNode.childNodes[0].getBBox().width-.5<this.getBBox().width&&d3.select(this).style("display","none")}var r={},i=[];t.forEach(function(t){if(t["Investing Amount/ Share (mio USD)"]&&t["Financier's name"]){r.hasOwnProperty(t["Financier's name"])||(r[t["Financier's name"]]={investing:0,countries:[],plants:[]});var e=r[t["Financier's name"]];e.investing+=parseFloat(t["Investing Amount/ Share (mio USD)"]),t["Financier's countries"]&&-1===e.countries.indexOf(t["Financier's countries"])&&e.countries.push(t["Financier's countries"]),t["Project Name"]&&-1===e.plants.indexOf(t["Project Name"])&&e.plants.push(t["Project Name"])}});for(var s in r)i.push({name:s,value:r[s].investing,countries:r[s].countries.join(", "),plants:r[s].plants.join(", ")});var c={value:0};i.length>0&&(c=i.reduce(function(t,e){return{value:t.value+e.value}})),document.getElementById("bank-invest-total").innerText=c.value+" (mio USD)",document.getElementById("proj-total").innerText="520000 (KgCO2)";var l=d3.layout.treemap().size([o,500]),u=l.nodes({children:i});u=u.slice(1,u.length);var p=d3.select("#bank-treemap").append("svg").attr("width",o).attr("height",500),d=p.selectAll("g").data(u).enter().append("g").on("mousemove",function(t){n(t,"<strong>Bank Name:"+t.name+"</strong><p>Investing Amount(mio USD): "+t.value.toFixed(2)+"</p>")}).on("mouseout",a);d.append("rect").attr({x:function(t){return t.x},y:function(t){return t.y},width:function(t){return t.dx},height:function(t){return t.dy},class:"bank-treemap-rect"}),d.append("text").attr({x:function(t){return t.x+t.dx/2},y:function(t){return t.y+t.dy/2},"text-anchor":"middle","dominant-baseline":"central"}).text(function(t){return t.name}).each(e);var m={},g=[];t.forEach(function(t){t["Investing Amount/ Share (mio USD)"]&&t["Financier's name"]&&(m.hasOwnProperty(t["Project Name"])||(m[t["Project Name"]]=0),m[t["Project Name"]]+=parseFloat(t["Investing Amount/ Share (mio USD)"]))});for(var s in m)g.push({name:s,value:m[s]});var f=d3.layout.treemap().size([o,400]),u=f.nodes({children:g});u=u.slice(1,u.length);var h=d3.select("#proj-treemap").append("svg").attr("width",o).attr("height",400),y=h.selectAll("g").data(u).enter().append("g").on("mousemove",function(t){n(t,"<strong>Project Name:"+t.name+"</strong><p>CO2 Carbon Emission: "+t.value.toFixed(2)+"</p>")}).on("mouseout",a);y.append("rect").attr({x:function(t){return t.x},y:function(t){return t.y},width:function(t){return t.dx},height:function(t){return t.dy},class:"proj-treemap-rect"}),y.append("text").attr({x:function(t){return t.x+t.dx/2},y:function(t){return t.y+t.dy/2},"text-anchor":"middle","dominant-baseline":"central"}).text(function(t){return t.name}).each(e);new Vue({el:"#bank-table",data:{bankArray:i}}),new Vue({el:"#proj-table",data:{projArray:g}})})}function n(t,e){var n=d3.event.pageX+5,a=d3.event.pageY+5;d3.select("#tooltip").style("left",n+"px").style("top",a+"px").html(function(){return e}),d3.select("#tooltip").classed("hidden",!1)}function a(){d3.select("#tooltip").classed("hidden",!0)}var r=["China","Taiwan","Japan","Vietnam","North Korea","South Korea","Philippines","Thailand","Malaysia","Indonesia","Cambodia","Laos","Myanmar","Singapore","Brunei","East Timor","Mongolia"],o=$(t).width(),i=$(t).height(),s=d3.select("#east-asia-map").append("svg").attr("width",o).attr("height",i);d3.select("body").append("div").attr("id","tooltip").classed("hidden",!0),t.init=e}(window);