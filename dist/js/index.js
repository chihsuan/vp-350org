!function(t){function e(e,l,u,p,d,m){document.getElementById("bank-vis-title").innerText="Financiers for "+e+" Coal Plant",document.getElementById("project-vis-title").innerText="Coal Plants in "+e;var g=i<600;g&&(u=p);var f=d3.geo.mercator().scale(u).center(l).translate([i/2+10,s/2+50]),h=d3.geo.path().projection(f);d3.json("./data/countries.geo.topo.json",function(l,u){d3.csv(d,function(p){if(l)return console.error(l);var d=topojson.feature(u,u.objects["countries.geo"]).features;d=d.filter(function(t){return t.properties.name===e}),c.append("g").attr("class","countries").selectAll("path").data(d).enter().append("path").attr("d",h).style("display",function(t){return o.indexOf(t.properties.name)>-1?"block":"none"}),c.append("path").attr("class","country-borders").attr("d",h(topojson.mesh(u,u.objects["countries.geo"],function(t,n){return t.properties.name===e&&t!==n}))),p=p.filter(function(t){return"Vietnam"===e?t.country===e&&t.latitude&&t.longitude:t.latitude&&t.longitude}).map(function(t){return t.longitude=parseFloat(t.longitude),t.latitude=parseFloat(t.latitude),t.capacity_mw=parseFloat(t.capacity_mw),t}),c.append("text").text(e).attr("class","map-title").attr("y",function(){return g?"120px":s/2}).attr("x",function(){return g?i/2:i-100}).attr("text-anchor",function(){return g?"middle":"end"}),c.append("text").text(function(){return p.length+" Coal Plants"}).attr("class","map-subtitle").attr("y",function(){return g?150:s/2+35}).attr("x",function(){return g?i/2:i-100}).attr("text-anchor",function(){return g?"middle":"end"}).attr("cursor","pointer").on("click",function(){t.location.href="#project-vis-title"});var m=g?10:25,x=d3.scale.linear().domain([0,d3.max(p,function(t){return t.capacity_mw})]).range([5,m]);c.selectAll("circle").data(p).enter().append("circle").attr("cx",function(t){return f([t.longitude,t.latitude])[0]}).attr("cy",function(t){return f([t.longitude,t.latitude])[1]}).attr("r",function(t){return x(t.capacity_mw)}).on("mousemove",function(t){"Vietnam"===e?a(t,"<p><strong>Plant: </strong>"+t.plant+"</p><p><strong>Capacity (MW): </strong>"+t.capacity_mw+"</p><p><strong>Coal Type: </strong>"+t.coal_type+"</p><p><strong>Unit: </strong>"+t.unit+"</p><p><strong>Year: </strong>"+t.year+"</p><p><strong>Status: </strong>"+t.status+"</p>"):a(t,"<p><strong>Project Name: </strong>"+t["Project Name"]+"</p><p><strong>Capacity (MW): </strong>"+t.capacity_mw+"</p><p><strong>Coal Type: </strong>"+t.Types+"</p><p><strong>Unit: </strong>"+t.Unit+"</p><p><strong>Year: </strong>"+t["Established date (yr)"]+"</p><p><strong>Status: </strong>"+t.Status+"</p>")}).on("mouseout",r);var y=s-40;c.append("circle").attr("cx",20).attr("cy",y).attr("r","8px").attr("fill","red"),c.append("text").attr("x",35).attr("y",y+5).attr("r","8px").attr("fill","red").attr("class","legend").text("Coal Plants Capacity"),c.append("text").attr("x",35).attr("y",function(){return g?y+25:y+30}).attr("r","8px").attr("fill","red").attr("class","legend").text("Data Last Updatedï¼š2017"),c.append("circle").attr("cx",20).attr("cy",function(){return g?y+20:y+25}).attr("r","5px").style("fill","#fff").style("stroke","none");var v=[];p=p.map(function(t){return t.value=t.capacity_mw,t.name=t["Project Name"]?t["Project Name"]:t.plant,t.name=t.name.replace("station",""),t}).filter(function(t){return!(v.indexOf(t.name)>-1)&&(v.push(t.name),!0)});var j=d3.layout.treemap().size([i,500]),w=j.nodes({children:p});w=w.slice(1,w.length);var b=d3.select("#proj-treemap").append("svg").attr("width",i).attr("height",500),C=b.selectAll("g").data(w).enter().append("g").on("mousemove",function(t){a(t,"<strong>Project Name:"+t.name+"</strong><p>CO2 Carbon Emission: "+t.value.toFixed(2)+"</p>")}).on("mouseout",r);C.append("rect").attr({x:function(t){return t.x},y:function(t){return t.y},width:function(t){return t.dx},height:function(t){return t.dy},class:"proj-treemap-rect"}),C.append("text").attr({x:function(t){return t.x+t.dx/2},y:function(t){return t.y+t.dy/2},"text-anchor":"middle","dominant-baseline":"central"}).text(function(t){return t.name}).each(n);new Vue({el:"#proj-table",data:{projArray:p}})})}),d3.csv(m,function(t){var e={},o=[];t.forEach(function(t){if(t["Investing Amount/ Share (mio USD)"]&&t["Financier's name"]){e.hasOwnProperty(t["Financier's name"])||(e[t["Financier's name"]]={investing:0,countries:[],plants:[]});var n=e[t["Financier's name"]];n.investing+=parseFloat(t["Investing Amount/ Share (mio USD)"]),t["Financier's countries"]&&-1===n.countries.indexOf(t["Financier's countries"])&&n.countries.push(t["Financier's countries"]),t["Project Name"]&&-1===n.plants.indexOf(t["Project Name"])&&n.plants.push(t["Project Name"])}});for(var s in e)o.push({name:s,value:e[s].investing,countries:e[s].countries.join(", "),plants:e[s].plants.join(", ")});var c={value:0};o.length>0&&(c=o.reduce(function(t,e){return{value:t.value+e.value}})),document.getElementById("bank-invest-total").innerText=c.value+" (mio USD)",document.getElementById("proj-total").innerText="XXXXX (KgCO2)";var l=d3.layout.treemap().size([i,500]),u=l.nodes({children:o});u=u.slice(1,u.length);var p=d3.select("#bank-treemap").append("svg").attr("width",i).attr("height",500),d=p.selectAll("g").data(u).enter().append("g").on("mousemove",function(t){a(t,"<strong>Bank Name:"+t.name+"</strong><p>Investing Amount(mio USD): "+t.value.toFixed(2)+"</p>")}).on("mouseout",r);d.append("rect").attr({x:function(t){return t.x},y:function(t){return t.y},width:function(t){return t.dx},height:function(t){return t.dy},class:"bank-treemap-rect"}),d.append("text").attr({x:function(t){return t.x+t.dx/2},y:function(t){return t.y+t.dy/2},"text-anchor":"middle","dominant-baseline":"central"}).text(function(t){return t.name}).each(n);new Vue({el:"#bank-table",data:{bankArray:o}})})}function n(t,e){var n=16,a=t.name,r=t.dx,o=t.dy;for(d3.select(this).style("font-size",n+"px");(this.getBBox().width>=r||this.getBBox().height>=o)&&n>10;)n--,d3.select(this).style("font-size",n+"px"),this.firstChild.data=a;this.parentNode.childNodes[0].getBBox().width-.5<this.getBBox().width&&d3.select(this).style("display","none")}function a(t,e){var n=d3.event.pageX+5,a=d3.event.pageY+5;d3.select("#tooltip").style("left",n+"px").style("top",a+"px").html(function(){return e}),d3.select("#tooltip").classed("hidden",!1)}function r(){d3.select("#tooltip").classed("hidden",!0)}var o=["China","Taiwan","Japan","Vietnam","North Korea","South Korea","Philippines","Thailand","Malaysia","Indonesia","Cambodia","Laos","Myanmar","Singapore","Brunei","East Timor","Mongolia"],i=$(t).width(),s=$(t).height(),c=d3.select("#east-asia-map").append("svg").attr("width",i).attr("height",s);d3.select("body").append("div").attr("id","tooltip").classed("hidden",!0),t.init=e}(window);