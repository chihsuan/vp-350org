!function(e){function t(e,t,s,u,d,l){var p=d3.geo.mercator().scale(function(){return c?u:s}).center(t).translate([r/2+10,o/2+50]);d3.geo.path().projection(p);document.getElementById("bank-vis-title").innerText="Financiers for "+e+" Coal Plant",document.getElementById("project-vis-title").innerText="Coal Plants in "+e,d3.csv(d,function(e){var t=e.filter(function(e){return e["Project Name"]||e.plant}).map(function(e){return e.value=parseFloat(e.capacity_mw),e.name=e["Project Name"]?e["Project Name"]:e.plant,e.name=e.name.replace("station",""),e}),o={};t.forEach(function(e){o.hasOwnProperty(e.name)?o[e.name].value+=e.value:o[e.name]=e});var c=[];Object.keys(o).forEach(function(e,t){c.push(o[e])});var s=d3.layout.treemap().size([r,500]),u=s.nodes({children:c});u=u.slice(1,u.length);var d=d3.select("#proj-treemap").append("svg").attr("width",r).attr("height",500),l=d.selectAll("g").data(u).enter().append("g").on("mousemove",function(e){a(e,"<strong>Project Name:"+e.name+"</strong><p>CO2 Carbon Emission: "+e.value.toFixed(2)+"</p>")}).on("mouseout",i);l.append("rect").attr({x:function(e){return e.x},y:function(e){return e.y},width:function(e){return e.dx},height:function(e){return e.dy},class:"proj-treemap-rect"}),l.append("text").attr({x:function(e){return e.x+e.dx/2},y:function(e){return e.y+e.dy/2},"text-anchor":"middle","dominant-baseline":"central"}).text(function(e){return e.name}).each(n);var p=c.reduce(function(e,t){return{value:e.value+t.value}});document.getElementById("proj-total").innerText=p.value+" (MW)";new Vue({el:"#proj-table",data:{plantData:t},computed:{projArray:function(){return this.plantData.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:e.Unit<t.Unit?-1:e.Unit>t.Unit?1:0})}}})}),d3.csv(l,function(e){var t={},o=[];e.forEach(function(e){if(e["Investing Amount/ Share (mio USD)"]&&e["Financier's name"]){t.hasOwnProperty(e["Financier's name"])||(t[e["Financier's name"]]={investing:0,countries:[],plants:[]});var n=t[e["Financier's name"]];n.investing+=parseFloat(e["Investing Amount/ Share (mio USD)"]),e["Financier's countries"]&&-1===n.countries.indexOf(e["Financier's countries"])&&n.countries.push(e["Financier's countries"]),e["Project Name"]&&-1===n.plants.indexOf(e["Project Name"])&&n.plants.push(e["Project Name"])}});for(var c in t)o.push({name:c,value:t[c].investing.toFixed(2),countries:t[c].countries.join(", "),plants:t[c].plants.join(", ")});var s={value:0};o.length>0&&(s=o.reduce(function(e,t){return{value:e.value+t.value}})),document.getElementById("bank-invest-total").innerText=s.value+" (mio USD)";var u=d3.layout.treemap().size([r,500]),d=u.nodes({children:o});d=d.slice(1,d.length);var l=d3.select("#bank-treemap").append("svg").attr("width",r).attr("height",500),p=l.selectAll("g").data(d).enter().append("g").on("mousemove",function(e){a(e,"<strong>Bank Name:"+e.name+"</strong><p>Investing Amount(mio USD): "+e.value.toFixed(2)+"</p>")}).on("mouseout",i);p.append("rect").attr({x:function(e){return e.x},y:function(e){return e.y},width:function(e){return e.dx},height:function(e){return e.dy},class:"bank-treemap-rect"}),p.append("text").attr({x:function(e){return e.x+e.dx/2},y:function(e){return e.y+e.dy/2},"text-anchor":"middle","dominant-baseline":"central"}).text(function(e){return e.name}).each(n);new Vue({el:"#bank-table",data:{bank:o},computed:{bankArray:function(){return this.bank.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:e.Unit<t.Unit?-1:e.Unit>t.Unit?1:0})}}})})}function n(e,t){var n=16,a=e.name,i=e.dx,r=e.dy;for(d3.select(this).style("font-size",n+"px");(this.getBBox().width>=i||this.getBBox().height>=r)&&n>10;)n--,d3.select(this).style("font-size",n+"px"),this.firstChild.data=a;this.parentNode.childNodes[0].getBBox().width-.5<this.getBBox().width&&d3.select(this).style("display","none")}function a(e,t){var n=d3.event.pageX+5,a=d3.event.pageY+5;d3.select("#tooltip").style("left",n+"px").style("top",a+"px").html(function(){return t}),d3.select("#tooltip").classed("hidden",!1)}function i(){d3.select("#tooltip").classed("hidden",!0)}var r=$(e).width(),o=$(e).height(),c=r<600;d3.select("#country-map").append("svg").attr("width",r).attr("height",o);d3.select("body").append("div").attr("id","tooltip").classed("hidden",!0),e.init=t}(window);